{% extends "ladder/base.html" %}
{% load url from future %}
{% load static from staticfiles %}
{% comment %}
	when inheriting from another template, the first line in the file should declare the inheritance.
	This is a must. Otherwise template inheritance will not work
{% endcomment %}
{% comment %} This defines comments within a template {% endcomment %}
{% comment %} OF SEARING IMPORTANCE: the 'extends' tag should be the first to appear
in order for template inheritance to work! {% endcomment %}
{% comment %} The following loads the 'static' tag, so that it can be used to load
static file assets {% endcomment %}
{% load static from staticfiles %}

{% block pagetitle %}Rutas de Carrera{% endblock %}

{% block includestylesheet %}
{% comment %} 
	The following tag outputs original text from the parent template
	so that the parent's content for this section isn't completely overridden
	
	In this case, CSS from the master form template will be added to this page's
	html-head
{% endcomment %}
		{{ block.super }}
{% endblock %}

{% block includejavascript %}
{% comment %} 
	The following tag outputs original text from the parent template
	so that the parent's content for this section isn't completely overridden 
	
	In this case, javascript from the master template will be added to this page's
	html-head
{% endcomment %}
		{{ block.super }}
{% endblock %}

{% block pagestyle %}

	.ui-autocomplete-loading {
        background: white url('{% static "ladder/images/ui-anim_basic_16x16.gif" %}') right center no-repeat;
    }
    
    .ui-autocomplete {
        max-height: 100px;
        max-width: 250px;
        overflow-y: auto;
        overflow-x: hidden;
        height: 100px;
        width: 250px;
    }
    
    .ui-combobox {
        position: relative;
        display: inline-block;
    }
    .ui-combobox-toggle {
        position: absolute;
        top: 0;
        bottom: 0;
        margin-left: -1px;
        padding: 0;
        /* adjust styles for IE 6/7 */
        *height: 1.7em;
        *top: 0.1em;
    }
    .ui-combobox-input {
        margin: 0;
        padding: 0.3em;
    }

{% endblock %}

{% block pageheader %}
	<h1>Rutas de carrera</h1>
{% endblock %}

{% block pagebody %}
	<div>
		<div class='input-append'>
			<label for='cargo_inicial_nombre'>Cargo actual: </label>
			<select id='cargo_inicial_nombre' name='cargo_inicial_nombre' type='text' class='dropdown'></select>
		</div>
		<span class='help-block'>Elija el cargo que usted ocupa en este momento</span>
	</div>
	<div class='toggled_by_cargo_inicial'>
		<div class='input-append'>
			<label for='cargo_destino_nombre'>Cargo Destino: </label>
			<select id='cargo_destino_nombre' name='cargo_destino_nombre' type='text'></select>
		</div>
		<span class='help-block'>Elija el cargo al que quiere llegar</span>
	</div>
{% endblock %}

{% block pagefooter %}
	<script>

		var pendingCargos = [];
		var destinations = {};
		var futurePaths = {};
		
		function rebuildPaths(){
			var keys = [];
			for(var key in futurePaths){
				keys[keys.length] = key;
			}
			//console.log(keys);
			for(var i = 0; i < keys.length; i++){
				var node = "futurePaths['" + keys[i] + "']";
				//console.log(keys[i]);
				//console.log(node);
				//console.log(eval(node));
				node = eval(node);
				//console.log(node.fields.siguientes);
				for(var j = 0; j < node.fields.siguientes.length; j++){
					//console.log('-->'+ node.fields.siguientes[j]);
					var reference = "futurePaths['" + node.fields.siguientes[j] + "']";
					reference = eval(reference);
					node.fields.siguientes[j] = reference;
					//console.log(reference);
				}
			}
		}
		
		function calculateRouteEndpoints_inspectChildrenFor(){
			//console.log('pending: ' + pendingCargos.length);
			//if there are no more items left to process, then stop
			if(pendingCargos.length <= 0)
				return;
			//dequeue a node and prevent it from being re-visited
			var node = pendingCargos[0];
			//dont re-visit a node
			while(futurePaths[ node ] && pendingCargos.length > 0){
				//console.log('already visited: ' + futurePaths[ node ]);
				pendingCargos = pendingCargos.slice(1, pendingCargos.length);
				//console.log('still have to check for: ' + pendingCargos.length + ' more node(s)');
				node = pendingCargos[0];
				//console.log('skipping to: ' + node);
			}
			//stop execution if current node has already been visited
			if(!node || node == null || node == undefined){
				rebuildPaths();
			}
			if(!node || futurePaths[ node ])
				return;
			//mark node being processed as visited
			futurePaths[ node ] = node;
			//print this for debugging
			//console.log('processing: ' + node);
			$.ajax({
				url: "{% url 'get-cargo-by-pk' 1 %}".slice(0,-2) + node + "/"
				, dataType: "json"
				, success: function(data, textStatus, jqXHR){
					if(data[0] && data[0].fields && data[0].fields.siguientes){
						for(var i = 0; i < data[0].fields.siguientes.length; i++){
							if( !futurePaths[ data[0].fields.siguientes[i] ] ){
								pendingCargos[pendingCargos.length] = data[0].fields.siguientes[i];
							}
						}
					} else {
						destinations[ destinations.length ] = node;
					}
					futurePaths[ node ] = data[0];
					if(pendingCargos.length>0){
						calculateRouteEndpoints_inspectChildrenFor();
					}
				}
				, error: function(jqXHR, textStatus, errorThrown){}
				, complete: function(jqXHR, textStatus){
					$('.toggled_by_cargo_inicial').css('visibility','visible');
				}
			});
		}
		
		//calculate available career routes
		function calculateRouteEndpoints(offSet){
			pendingCargos = [];
			destinations = {};
			futurePaths = {};
			pendingCargos[pendingCargos.length] = offSet;
			calculateRouteEndpoints_inspectChildrenFor();
		}
		
		//load all available cargos
		function loadOffsetCargos(){
			$.ajax({
				url: "{% url 'get-cargos' %}"
				, dataType: "json"
				, data: {
					//don't send any data to the service
				}, success: function(data, textStatus, jqXHR){
					$.map( data, function( item ) {
						$('#cargo_inicial_nombre').append(
							$('<option value="' + item.pk + '">' + item.fields.nombre + '</option>')
						);
					})
				}, complete: function(jqHXR, textStatus){
					//done requesting data
				}, error: function(jqXHR, textStatus, errorThrown){
					alert(textStatus);
				}
			});
			$('select').combobox();
		}
	
		$(document).ready(function(){
			loadOffsetCargos();
			//fix sizes for input fields
			$('div.input-append button').css('height','2em');
			$('div.input-append input').css('height','1.3em');
			
			$('#cargo_inicial_nombre').change(function(){
				var selected = $('#cargo_inicial_nombre option:selected')[0].value;
				calculateRouteEndpoints(selected);
				/*
				$.ajax({
					url: "{% url 'get-cargos-destino' 1 %}".slice(0,-2) + selected + "/"
					, dataType: "json"
					, data: {
						//don't send any data to the service
					}, success: function(data, textStatus, jqXHR){
						$('#cargo_destino_nombre').empty();
						$.map( data, function( item ) {
							$('#cargo_destino_nombre').append(
								$('<option value="' + item.pk + '">' + item.fields.nombre + '</option>')
							);
						})
					}, complete: function(jqXHR, textStatus){
						//done requesting data
					}, error: function(jqXHR, textStatus, errorThrown){
						alert(textStatus);
					}
				});
				*/
			});
			/*
			$('#cargo_inicial_nombre').autocomplete({
				source: function(request, response){
					console.log("{% url 'get-cargos' %}" + request.term + "/");
					$.ajax({
						url: "{% url 'get-cargos' %}" + request.term
						, dataType: "json"
						, data: {
							//don't send any data to the service
						}, success: function(data, textStatus, jqXHR){
							response( $.map( data, function( item ) {
								return {
									label: item.fields.nombre,
									value: item.pk
								}
							}));
						}, complete: function(jqXHR, textStatus){
							//done requesting data
						}, error: function(jqXHR, textStatus, errorThrown){
							alert(textStatus);
						}
					});
				}, minLength: 2,
				select: function(event, ui){
					if(ui.item){
						console.log(ui.item.value);
						$('#cargo_inicial_nombre').val(ui.item.label);
						$('#cargo_inicial').val(ui.item.value);
						return false;
					}
				}, open: function(){
					$(this).removeClass('ui-corner-all').addClass('ui-corner-top');
				}, close: function(){
					$(this).removeClass('ui-corner-top').addClass('ui-corner-all');
				}
			})*//*.data("autocomplete")._renderItem = function( ul, item ){
				return $( "<li>" )
                .data( "item.autocomplete", item )
                .append( "<a>" + item.label + "<br>" + item.value + "</a>" )
                .appendTo( ul );
			}*/;
		});
	</script>
	<script>
		//hide destination cargo until an offset cargo has been chosen
		$('.toggled_by_cargo_inicial').css('visibility','hidden');
	</script>
{% endblock %}
{% comment %}
	See built in thempalte tags and filters at:
	https://docs.djangoproject.com/en/dev/ref/templates/builtins/?from=olddocs
	
	See basic template syntax at:
	https://docs.djangoproject.com/en/dev/ref/templates/api/
	
	https://docs.djangoproject.com/en/1.4/topics/templates/
{% endcomment %}
